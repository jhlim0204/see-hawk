<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>control/DataManager.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="APIManager.html">APIManager</a><ul class='methods'><li data-type='method'><a href="APIManager.html#.cleanAddress">cleanAddress</a></li><li data-type='method'><a href="APIManager.html#.fetchCarpark">fetchCarpark</a></li><li data-type='method'><a href="APIManager.html#.fetchHawkerCentre">fetchHawkerCentre</a></li></ul></li><li><a href="AuthManager.html">AuthManager</a><ul class='methods'><li data-type='method'><a href="AuthManager.html#.authListener">authListener</a></li><li data-type='method'><a href="AuthManager.html#.login">login</a></li><li data-type='method'><a href="AuthManager.html#.logout">logout</a></li><li data-type='method'><a href="AuthManager.html#.register">register</a></li></ul></li><li><a href="CarparkDetail.html">CarparkDetail</a><ul class='methods'><li data-type='method'><a href="CarparkDetail.html#render">render</a></li></ul></li><li><a href="CarparkManager.html">CarparkManager</a><ul class='methods'><li data-type='method'><a href="CarparkManager.html#.fetchNearbyCarpark">fetchNearbyCarpark</a></li></ul></li><li><a href="CarparkMarker.html">CarparkMarker</a><ul class='methods'><li data-type='method'><a href="CarparkMarker.html#render">render</a></li></ul></li><li><a href="CarparkPage.html">CarparkPage</a><ul class='methods'><li data-type='method'><a href="CarparkPage.html#componentDidMount">componentDidMount</a></li><li data-type='method'><a href="CarparkPage.html#render">render</a></li></ul></li><li><a href="DataManager.html">DataManager</a><ul class='methods'><li data-type='method'><a href="DataManager.html#.addFavourite">addFavourite</a></li><li data-type='method'><a href="DataManager.html#.addReview">addReview</a></li><li data-type='method'><a href="DataManager.html#.checkIfIDExist">checkIfIDExist</a></li><li data-type='method'><a href="DataManager.html#.deleteFavourite">deleteFavourite</a></li><li data-type='method'><a href="DataManager.html#.getFavourite">getFavourite</a></li><li data-type='method'><a href="DataManager.html#.getReview">getReview</a></li><li data-type='method'><a href="DataManager.html#.isFavourite">isFavourite</a></li><li data-type='method'><a href="DataManager.html#.retrieveHawkerCentreDetails">retrieveHawkerCentreDetails</a></li><li data-type='method'><a href="DataManager.html#.searchHawkerCentre">searchHawkerCentre</a></li><li data-type='method'><a href="DataManager.html#.shouldUpdate">shouldUpdate</a></li><li data-type='method'><a href="DataManager.html#.updateFireBaseHawkerCentreList">updateFireBaseHawkerCentreList</a></li><li data-type='method'><a href="DataManager.html#.updateTime">updateTime</a></li></ul></li><li><a href="FavouriteComponent.html">FavouriteComponent</a><ul class='methods'><li data-type='method'><a href="FavouriteComponent.html#render">render</a></li></ul></li><li><a href="FavouriteManager.html">FavouriteManager</a><ul class='methods'><li data-type='method'><a href="FavouriteManager.html#.addFavourite">addFavourite</a></li><li data-type='method'><a href="FavouriteManager.html#.deleteFavourite">deleteFavourite</a></li><li data-type='method'><a href="FavouriteManager.html#.getFavourite">getFavourite</a></li><li data-type='method'><a href="FavouriteManager.html#.isFavourite">isFavourite</a></li></ul></li><li><a href="FavouritePage.html">FavouritePage</a><ul class='methods'><li data-type='method'><a href="FavouritePage.html#componentDidMount">componentDidMount</a></li><li data-type='method'><a href="FavouritePage.html#render">render</a></li></ul></li><li><a href="FavouriteToggle.html">FavouriteToggle</a><ul class='methods'><li data-type='method'><a href="FavouriteToggle.html#componentDidMount">componentDidMount</a></li><li data-type='method'><a href="FavouriteToggle.html#render">render</a></li></ul></li><li><a href="FilterManager.html">FilterManager</a><ul class='methods'><li data-type='method'><a href="FilterManager.html#.convertAddressToRegion">convertAddressToRegion</a></li><li data-type='method'><a href="FilterManager.html#.filter">filter</a></li><li data-type='method'><a href="FilterManager.html#.filterRegion">filterRegion</a></li><li data-type='method'><a href="FilterManager.html#.filterStar">filterStar</a></li></ul></li><li><a href="GiveReview.html">GiveReview</a><ul class='methods'><li data-type='method'><a href="GiveReview.html#render">render</a></li></ul></li><li><a href="HawkerCentreManager.html">HawkerCentreManager</a><ul class='methods'><li data-type='method'><a href="HawkerCentreManager.html#.retrieveHawkerCentreDetails">retrieveHawkerCentreDetails</a></li><li data-type='method'><a href="HawkerCentreManager.html#.searchHawkerCentre">searchHawkerCentre</a></li></ul></li><li><a href="HawkerMarker.html">HawkerMarker</a><ul class='methods'><li data-type='method'><a href="HawkerMarker.html#render">render</a></li></ul></li><li><a href="HawkerPage.html">HawkerPage</a><ul class='methods'><li data-type='method'><a href="HawkerPage.html#componentDidMount">componentDidMount</a></li><li data-type='method'><a href="HawkerPage.html#getHawkerCenterDetail">getHawkerCenterDetail</a></li><li data-type='method'><a href="HawkerPage.html#render">render</a></li></ul></li><li><a href="HawkerPlaceholder.html">HawkerPlaceholder</a><ul class='methods'><li data-type='method'><a href="HawkerPlaceholder.html#render">render</a></li></ul></li><li><a href="HawkerResult.html">HawkerResult</a><ul class='methods'><li data-type='method'><a href="HawkerResult.html#render">render</a></li></ul></li><li><a href="Header.html">Header</a><ul class='methods'><li data-type='method'><a href="Header.html#render">render</a></li></ul></li><li><a href="HomePage.html">HomePage</a><ul class='methods'><li data-type='method'><a href="HomePage.html#componentDidMount">componentDidMount</a></li><li data-type='method'><a href="HomePage.html#render">render</a></li></ul></li><li><a href="Login.html">Login</a><ul class='methods'><li data-type='method'><a href="Login.html#render">render</a></li></ul></li><li><a href="LoginRegister.html">LoginRegister</a><ul class='methods'><li data-type='method'><a href="LoginRegister.html#render">render</a></li></ul></li><li><a href="Logout.html">Logout</a><ul class='methods'><li data-type='method'><a href="Logout.html#render">render</a></li></ul></li><li><a href="Main.html">Main</a><ul class='methods'><li data-type='method'><a href="Main.html#componentDidMount">componentDidMount</a></li><li data-type='method'><a href="Main.html#render">render</a></li></ul></li><li><a href="Profile.html">Profile</a><ul class='methods'><li data-type='method'><a href="Profile.html#render">render</a></li></ul></li><li><a href="Register.html">Register</a><ul class='methods'><li data-type='method'><a href="Register.html#render">render</a></li></ul></li><li><a href="RegisterManager.html">RegisterManager</a><ul class='methods'><li data-type='method'><a href="RegisterManager.html#.register">register</a></li></ul></li><li><a href="ReviewDetail.html">ReviewDetail</a><ul class='methods'><li data-type='method'><a href="ReviewDetail.html#render">render</a></li></ul></li><li><a href="ReviewManager.html">ReviewManager</a><ul class='methods'><li data-type='method'><a href="ReviewManager.html#.addReview">addReview</a></li><li data-type='method'><a href="ReviewManager.html#.calculateAverage">calculateAverage</a></li><li data-type='method'><a href="ReviewManager.html#.calculatePercentage">calculatePercentage</a></li><li data-type='method'><a href="ReviewManager.html#.getReview">getReview</a></li></ul></li><li><a href="ReviewPage.html">ReviewPage</a><ul class='methods'><li data-type='method'><a href="ReviewPage.html#render">render</a></li></ul></li><li><a href="ReviewSummary.html">ReviewSummary</a><ul class='methods'><li data-type='method'><a href="ReviewSummary.html#render">render</a></li></ul></li><li><a href="SearchBar.html">SearchBar</a><ul class='methods'><li data-type='method'><a href="SearchBar.html#render">render</a></li></ul></li><li><a href="SearchPage.html">SearchPage</a><ul class='methods'><li data-type='method'><a href="SearchPage.html#componentDidMount">componentDidMount</a></li><li data-type='method'><a href="SearchPage.html#render">render</a></li></ul></li><li><a href="SessionManager.html">SessionManager</a><ul class='methods'><li data-type='method'><a href="SessionManager.html#.authListener">authListener</a></li><li data-type='method'><a href="SessionManager.html#.login">login</a></li><li data-type='method'><a href="SessionManager.html#.logout">logout</a></li></ul></li><li><a href="SidebarPlaceholder.html">SidebarPlaceholder</a><ul class='methods'><li data-type='method'><a href="SidebarPlaceholder.html#render">render</a></li></ul></li><li><a href="ViewOnMap.html">ViewOnMap</a><ul class='methods'><li data-type='method'><a href="ViewOnMap.html#render">render</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#App">App</a></li><li><a href="global.html#DisplayStarsSmall">DisplayStarsSmall</a></li><li><a href="global.html#HawkerPagePlaceholder">HawkerPagePlaceholder</a></li><li><a href="global.html#ReviewPagePlaceholder">ReviewPagePlaceholder</a></li><li><a href="global.html#UserContext">UserContext</a></li><li><a href="global.html#firebaseConfig">firebaseConfig</a></li><li><a href="global.html#root">root</a></li><li><a href="global.html#withRouter">withRouter</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">control/DataManager.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { db } from '../firebase.js';
import {
    doc,
    getDoc,
    updateDoc,
    setDoc,
    arrayRemove,
    arrayUnion,
    collection,
    getDocs,
    query,
    where
} from 'firebase/firestore';
import { APIManager } from './APIManager.js';

/**
 * Class for interacting with database
 * Use case - UC04, UC05, UC06, UC07, UC10, UC11
 * @author Leong Hong Yi
 */
export class DataManager {
    /**
     * Constructor for DataManager
     * @throw Will throw an error if this static class is instantiated
     */
    constructor() {
        throw Error('A static class cannot be instantiated.');
    }

    /**
     * Method to get the review of hawker centre through its ID
     * @param {string} hawkerCentreID - The ID of the hawker centre
     * @return {Object[] | boolean} If target hawker centre exists, the list of reviews is returned. Else false is returned.
     */
    static async getReview(hawkerCentreID) {
        const hawkerCentreRef = doc(db, 'HawkerCentre', hawkerCentreID);
        const hawkerCentre = await getDoc(hawkerCentreRef);
        if (hawkerCentre.exists()) {
            return hawkerCentre.data().reviewList;
        } else {
            console.log('No such document!');
            return false;
        }
    }

    /**
     * Method to add review to hawker centre
     * @param {string} hawkercentreID - The ID of the hawker centre
     * @param {string} accoundID - The ID of the account
     * @param {number} reviewStar - The numerical rating of the review
     * @param {string} reviewText - The text rating of the review
     * @return {boolean} Whether review is succesfully added
     */
    static async addReview(hawkerCentreID, accountID, reviewStar, reviewText) {
        let retrievedReviewList = await DataManager.getReview(hawkerCentreID);
        console.log(retrievedReviewList);
        retrievedReviewList[accountID] = { reviewStar: reviewStar, reviewText: reviewText };
        const hawkerCentreRef = doc(db, 'HawkerCentre', hawkerCentreID);

        try {
            await updateDoc(hawkerCentreRef, {
                reviewList: retrievedReviewList
            });
            return true;
        } catch (error) {
            console.log('Error adding review');
            return false;
        }
    }

    /**
     * Method to get favourites of an account
     * @param {string} accountName - The name of the account
     * @return {Object[]} The list of favourites of that account
     */
    static async getFavourite(accountName) {
        const docRef = doc(db, 'Account', accountName);
        const docSnap = await getDoc(docRef);

        if (!docSnap.exists()) {
            return [];
        }

        const favouriteList = docSnap.data().favList;

        const returnList = [];
        for (let favourite of favouriteList) {
            let tempFavouriteDetail = await DataManager.retrieveHawkerCentreDetails(favourite);
            let favouriteDetail = (({ name, address, photoURL, noOfStall }) => ({
                name,
                address,
                photoURL,
                noOfStall
            }))(tempFavouriteDetail);
            favouriteDetail.id = favourite;
            returnList.push(favouriteDetail);
        }

        return returnList;
    }

    /**
     * Method to check if hawker centre is the favourite of an account
     * @param {string} accountName - The name of the account
     * @param {string} hawkerID- The ID of the hawker centre
     * @return {boolean} Whether the hawker centre is the favourite of the account
     */
    static async isFavourite(accountName, hawkerID) {
        if (!accountName) {
            return false;
        }

        const docRef = doc(db, 'Account', accountName);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
            const favouriteList = docSnap.data().favList;
            return favouriteList.includes(hawkerID);
        } else {
            return false;
        }
    }

    /**
     * Method to add favourite to an account
     * @param {string} accountName - The name of the account
     * @param {string} hawkerID- The ID of the hawker centre
     * @returns {boolean} Whether the favourite is succesfully added
     */
    static async addFavourite(accountName, hawkerID) {
        const docRef = doc(db, 'Account', accountName);
        const account = await getDoc(docRef);

        if (account.exists()) {
            await updateDoc(docRef, {
                favList: arrayUnion(hawkerID)
            })
                .then(() => {
                    return true;
                })
                .catch(() => {
                    return false;
                });
        } else {
            await setDoc(docRef, {
                favList: arrayUnion(hawkerID)
            })
                .then(() => {
                    return true;
                })
                .catch(() => {
                    return false;
                });
        }
    }

    /**
     * Method to delete favourite from an account
     * @param {string} accountName - The name of the account
     * @param {string} hawkerID- The ID of the hawker centre
     * @returns {boolean} Whether the favourite is succesfully removed
     */
    static async deleteFavourite(accountName, hawkerID) {
        const docRef = doc(db, 'Account', accountName);
        await updateDoc(docRef, {
            favList: arrayRemove(hawkerID)
        })
            .then(() => {
                return true;
            })
            .catch(() => {
                return false;
            });
    }

    /**
     * Method to retrive the details of hawker centre
     * @param {string} hawkerCentreID - The ID of the hawker centre
     * @return {Object} The details of the hawker centre
     */
    static async retrieveHawkerCentreDetails(hawkerCentreID) {
        // update firebase if needed
        DataManager.updateFireBaseHawkerCentreList();
        //Return hawkerCentre object with relevant attributes
        let retrievedHawkerCentre;
        const hawkerCentreRef = doc(db, 'HawkerCentre', hawkerCentreID);
        try {
            const hawkerCentre = await getDoc(hawkerCentreRef);
            retrievedHawkerCentre = hawkerCentre.data();
            delete retrievedHawkerCentre.reviewList;

            return retrievedHawkerCentre;
        } catch (error) {
            return null;
        }
    }

    /**
     * Method to search for hawker centre
     * @param {string} subString - The sub string to be searched
     * @return {Object[]} The matched hawker centres
     */
    static async searchHawkerCentre(subString) {
        // update firebase if needed
        DataManager.updateFireBaseHawkerCentreList();
        //Get all the hawker centre where name contains subString
        const hawkerCentreRef = collection(db, 'HawkerCentre');
        const q = query(hawkerCentreRef, where('name', '!=', null));
        let returnList = [];

        //Firebase doesn't support query by substring. Since our database is not very large we decided to fetch all documents and filter them, as a workaround.

        const hawkerCentreList = await getDocs(q);

        hawkerCentreList.forEach((doc) => {
            if (
                doc
                    .data()
                    .name.toUpperCase()
                    .replace(/\s/g, '')
                    .includes(subString.toUpperCase().replace(/\s/g, ''))
            ) {
                returnList.push({
                    id: doc.id,
                    name: doc.data().name,
                    address: doc.data().address,
                    noOfStall: doc.data().noOfStall,
                    photoURL: doc.data().photoURL
                });
            }
        });

        return returnList;
    }

    /**
     * Method to check if the hawker centre exists in the database
     * @param {string} hawkerCentreID - The ID of the hawker centre
     * @return {boolean} Whether the hawker centre exists
     */
    static async checkIfIDExist(hawkerCentreID) {
        const hawkerCentreRef = doc(db, 'HawkerCentre', hawkerCentreID);
        const hawkerCentre = await getDoc(hawkerCentreRef);

        return hawkerCentre.exists();
    }

    /**
     * Method to update time
     */
    static async updateTime() {
        const timeRef = doc(db, 'Time', 'updateTime');
        await setDoc(timeRef, {
            time: Date.now()
        });
    }

    /**
     * Method to check if database should be updated
     * @return {boolean} Whether the database is last updated more than 7 days ago
     */
    static async shouldUpdate() {
        let currentTime = Date.now();
        const previousTimeRef = doc(db, 'Time', 'updateTime');
        const pTime = await getDoc(previousTimeRef);
        let previousUpdateTime = pTime.data().time;

        return previousUpdateTime + 604800000 &lt;= currentTime;
    }

    /**
     * Method to update firestore hawker centre database
     */
    static async updateFireBaseHawkerCentreList() {
        if (await DataManager.shouldUpdate()) {
            await DataManager.updateTime();

            const updatedHawkerCentreList = await APIManager.fetchHawkerCentre();
            for (const hawkerCentre of updatedHawkerCentreList) {
                var exist = await DataManager.checkIfIDExist(hawkerCentre.id);

                if (exist) {
                    var hawkerCentreRef = doc(db, 'HawkerCentre', hawkerCentre.id);
                    await updateDoc(hawkerCentreRef, hawkerCentre);
                } else {
                    await setDoc(doc(db, 'HawkerCentre', hawkerCentre.id), {
                        ...hawkerCentre,
                        reviewList: {}
                    });
                }
            }
        }
    }
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.2</a> on Fri Apr 07 2023 21:24:34 GMT+0800 (Malaysia Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
